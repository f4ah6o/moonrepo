# 2026-02-25 開発日誌

## 今日の計画

1. `airlock.mbt` の Direct 連携で、時間経過後に受信停止する問題を再接続ロジックで改善する。
2. Bot トークン再取得を自動化し、手動再起動なしで復旧できるようにする。
3. 起動コマンドを簡略化し、運用で毎回同じ手順を使えるようにする。

## 実装内容

- `repos/airlock.mbt/src/adapters/direct_adapter.mbt`
  - `DirectAdapter::is_connected` / `DirectAdapter::is_authenticated` を追加。
  - `EVENT_SESSION_ERROR` / `EVENT_NOTIFICATION_ERROR` / `EVENT_DECODE_ERROR` 受信時に `AdapterState::Error` を設定。
- `repos/airlock.mbt/src/cmd/it_support_app/main_native.mbt`
  - 接続ヘルス監視を追加し、不健康状態を検知したら adapter をリセット。
  - `daab login --force` を内部実行して Bot トークンを再取得する処理を追加。
  - 再接続失敗時の指数バックオフ（最大 60 秒）を追加。
  - `read_direct_startup_config` で `../direct_sdk.mbt/.env` をフォールバック参照するよう更新。
  - `try_start_direct_bridge` を `Bool` 戻り値に変更し、接続可否を再接続ループへ返すようにした。
- `repos/airlock.mbt/justfile`
  - `direct-prepare-bot`, `direct-prepare-all`, `app-stable` を追加。
  - `direct-env-check` が `../direct_sdk.mbt/.env` の `HUBOT_DIRECT_TOKEN` を参照できるよう改善。
  - ヘルプに `app-stable` 推奨フローを追加。
- `repos/airlock.mbt/PLAN.md`
  - 実装計画を保存。

## 学び

- Direct WebSocket の「接続済み」に見える状態でも、`session error` を拾わないと受信停止に見えることがある。
- そのため、`connected` フラグだけでなく `authenticated` と adapter state を同時監視する設計が必要。

## 検証

- `moon -C repos/airlock.mbt check --target native`

## スクリーンショット

- 今回は CLI とログ中心の修正のため、スクリーンショットは未取得。
